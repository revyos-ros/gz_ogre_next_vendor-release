From 514721128309fabe7af30cf8deb46d6ee01f28bc Mon Sep 17 00:00:00 2001
From: Zheng Junjie <zhengjunjie@iscas.ac.cn>
Date: Thu, 20 Jun 2024 13:20:11 +0800
Subject: [PATCH 2/2] add riscv64 support patch.

---
 .../0001-disable-SIMD-on-riscv64.patch        | 25 --------
 debian/patches/0001-riscv64-support.patch     | 62 +++++++++++++++++++
 debian/patches/series                         |  2 +-
 3 files changed, 63 insertions(+), 26 deletions(-)
 delete mode 100644 debian/patches/0001-disable-SIMD-on-riscv64.patch
 create mode 100644 debian/patches/0001-riscv64-support.patch

diff --git a/debian/patches/0001-disable-SIMD-on-riscv64.patch b/debian/patches/0001-disable-SIMD-on-riscv64.patch
deleted file mode 100644
index 72ab5d3..0000000
--- a/debian/patches/0001-disable-SIMD-on-riscv64.patch
+++ /dev/null
@@ -1,25 +0,0 @@
-From 015a28a5ca52937cb8e8c27e22f6b477aeeed918 Mon Sep 17 00:00:00 2001
-From: Zheng Junjie <zhengjunjie@iscas.ac.cn>
-Date: Tue, 18 Jun 2024 11:00:39 +0800
-Subject: [PATCH] disable SIMD on riscv64.
-
----
- CMakeLists.txt | 2 +-
- 1 file changed, 1 insertion(+), 1 deletion(-)
-
-diff --git a/CMakeLists.txt b/CMakeLists.txt
-index a904707..a928ced 100644
---- a/CMakeLists.txt
-+++ b/CMakeLists.txt
-@@ -5,7 +5,7 @@ find_package(ament_cmake REQUIRED)
- find_package(ament_cmake_vendor_package REQUIRED)
- 
- set(EXTRA_CMAKE_FLAGS)
--if(CMAKE_SYSTEM_PROCESSOR MATCHES "^(aarch64.*|AARCH64.*|arm64.*|ARM64.*|arm.*|ARM.*)")
-+if(CMAKE_SYSTEM_PROCESSOR MATCHES "^(aarch64.*|AARCH64.*|arm64.*|ARM64.*|arm.*|ARM.*|riscv64.*)")
-   # Flags for non SIMD architectures
-   # https://github.com/gazebo-forks/ogre-2.3-release/blob/960bb19664879282b979e4ed8cb3ce278c875bdb/debian/rules#L21-L28
-   set(EXTRA_CMAKE_FLAGS -DOGRE_SIMD_NEON:BOOL=FALSE  -DOGRE_SIMD_SSE2:BOOL=FALSE)
--- 
-2.41.0
-
diff --git a/debian/patches/0001-riscv64-support.patch b/debian/patches/0001-riscv64-support.patch
new file mode 100644
index 0000000..56047c3
--- /dev/null
+++ b/debian/patches/0001-riscv64-support.patch
@@ -0,0 +1,62 @@
+From e3dedf2f4482553e307d9dbcd9fa7484824c3433 Mon Sep 17 00:00:00 2001
+From: Zheng Junjie <zhengjunjie@iscas.ac.cn>
+Date: Tue, 18 Jun 2024 11:00:39 +0800
+Subject: [PATCH] riscv64 support.
+
+---
+ CMakeLists.txt                             |  3 ++-
+ patches/riscv64-ppc64-64bits-support.patch | 21 +++++++++++++++++++++
+ 2 files changed, 23 insertions(+), 1 deletion(-)
+ create mode 100644 patches/riscv64-ppc64-64bits-support.patch
+
+diff --git a/CMakeLists.txt b/CMakeLists.txt
+index a904707..dc0400f 100644
+--- a/CMakeLists.txt
++++ b/CMakeLists.txt
+@@ -5,7 +5,7 @@ find_package(ament_cmake REQUIRED)
+ find_package(ament_cmake_vendor_package REQUIRED)
+ 
+ set(EXTRA_CMAKE_FLAGS)
+-if(CMAKE_SYSTEM_PROCESSOR MATCHES "^(aarch64.*|AARCH64.*|arm64.*|ARM64.*|arm.*|ARM.*)")
++if(CMAKE_SYSTEM_PROCESSOR MATCHES "^(aarch64.*|AARCH64.*|arm64.*|ARM64.*|arm.*|ARM.*|riscv64.*)")
+   # Flags for non SIMD architectures
+   # https://github.com/gazebo-forks/ogre-2.3-release/blob/960bb19664879282b979e4ed8cb3ce278c875bdb/debian/rules#L21-L28
+   set(EXTRA_CMAKE_FLAGS -DOGRE_SIMD_NEON:BOOL=FALSE  -DOGRE_SIMD_SSE2:BOOL=FALSE)
+@@ -35,6 +35,7 @@ ament_vendor(${PROJECT_NAME}
+   GLOBAL_HOOK
+   PATCHES
+     patches/0001-Fix-incomplete-vulkan-linkage.patch
++    patches/riscv64-ppc64-64bits-support.patch
+ )
+ 
+ if(BUILD_TESTING)
+diff --git a/patches/riscv64-ppc64-64bits-support.patch b/patches/riscv64-ppc64-64bits-support.patch
+new file mode 100644
+index 0000000..d00b84e
+--- /dev/null
++++ b/patches/riscv64-ppc64-64bits-support.patch
+@@ -0,0 +1,21 @@
++Description: Include riscv64 support and ppc64el support
++Author: Jose Luis Rivero <jrivero@osrfoundation.org>
++Forwarded: no
++Last-Update: 2024-02-10
++---
++--- a/OgreMain/include/OgrePlatform.h
+++++ b/OgreMain/include/OgrePlatform.h
++@@ -76,10 +76,11 @@
++ 
++ /* Find the arch type */
++ #if defined(__x86_64__) || defined(_M_X64) || defined(_M_X64) || defined(_M_AMD64) \
++- || defined(__ppc64__) \
+++ || defined(__ppc64__) || defined(__PPC64__) \
++  || defined(__arm64__) || defined(__aarch64__) || defined(_M_ARM64) \
++  || defined(__mips64) || defined(__mips64_) \
++- || defined(__alpha__) || defined(__ia64__) || defined(__e2k__) || defined(__s390__) || defined(__s390x__)
+++ || defined(__alpha__) || defined(__ia64__) || defined(__e2k__) || defined(__s390__) || defined(__s390x__) \
+++ || (defined(__riscv) && (__riscv_xlen == 64))
++ #   define OGRE_ARCH_TYPE OGRE_ARCHITECTURE_64
++ #else
++ #   define OGRE_ARCH_TYPE OGRE_ARCHITECTURE_32
+-- 
+2.41.0
+
diff --git a/debian/patches/series b/debian/patches/series
index 57150f8..baed013 100644
--- a/debian/patches/series
+++ b/debian/patches/series
@@ -1 +1 @@
-0001-disable-SIMD-on-riscv64.patch
+0001-riscv64-support.patch
-- 
2.41.0

